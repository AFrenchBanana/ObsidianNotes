Windows functions in 2 main modes 
### User mode 
* The mode were most applications and user processes operate. Have limited access to system resources and must interact with the operating system through APIs. 
* In this mode malware can still manipulate files, registry settings and network connections. 
### Kernel Mode
* Highly privileged mode where the Windows kernel runs. The Kernel has unrestricted access to system resources, hardware and critical functions. 

## Windows Architecture
![[Pasted image 20231031090614.png]]
### User-mode Components
* Parts of the operating system that don't have direct access to hardware or kernel data structures. They interact with API and system calls.
	* *System Support Processes* : These are essential components that provide crucial functionalities and services such as logon processes (*winlogon.exe*), Session manager (*smss.exe*) and Service Control Manager (*services.exe*). They aren't Window services but are necessary for the system to work. 
	* *Service Processes* : These processes host Windows services liek the *Winodws Update Service, Task Scheduler* and *Print Spooler* Services. They usually run in the background 
	* *User Applications*: Processes created by user programs, including both 32-bit and 64-bit applications. They interact with the operating systems through APIs provided by Windows. The API calls get redirected to [NTDLL.DLL](https://en.wikipedia.org/wiki/Microsoft_Windows_library_files#NTDLL.DLL). This triggers a transition from user to kernel modes. The result is then returned to the user-mode application. 
	* *Environment Subsystem*: Responsible for providing execution for specific types of applications or processes. Examples: *Win32*, *Subsystem*, *POSIX*, *OS/2*
	* *Subsytem DLLS*: Dynamic Link Libraries that translate documented functions into appropiate internal native system calls. Primarily implemented in *NTDLL.DLL*. Examples: *kernelbase.dll*, *user32.dll*
### Kernel-mode Components
* Parts of the operating system that have direct access to hardware and kernel data structures. 
	* *Executive*: Upper layer in kernel mode gets accessed through functions from *NTDLL.DLL*. Consists of components like *I/O manager*, *Object Manager* , *Security Reference*, *Process Manager*
	* *Kernel*: Component manages system resources, providing low-level services like *thread scheduling*, *interrupt and exemption dispatching* and *multiprocessor sync*
	* *Device Drivers*: Enable the OS to interact with hardware devices
	* *Hardware Abstraction Layer (HAL)*: Provides an abstraction layer between the hardware devices and the OS. 
	* *Windowing and Graphics System (Win32k.sys)*: Responsible for managing the GUI. 
## Windows API Call flow. 
* Malware often utilise Windows API calls to interact with the system and carry out, malicious operations. 
![[Pasted image 20231031094901.png]]
* When this function is called, some required parameters are also passed to it. Such as the handle for the target processes. 
### Example:
* *ReadProcessMemory* WINAPI function syntax:
```C++
BOOL ReadProcessMemory(
  [in]  HANDLE  hProcess,
  [in]  LPCVOID lpBaseAddress,
  [out] LPVOID  lpBuffer,
  [in]  SIZE_T  nSize,
  [out] SIZE_T  *lpNumberOfBytesRead
);
```
* *ReadProcessMemory* is a windows API function in *kernel32.dll*. This call is invoked via *kernel32.dll*. This serves as the user mode interface to the Windows API. 
*![[Pasted image 20231031095404.png]]
* This function request is translated to the corresponding Native API call which is *NtReadVirtualMemory*
* *NTDLL.DLL* uses system calls. 
![[Pasted image 20231031095419.png]]
* The syscall instruction triggers the system call using the parameters set in the previous instruction. It transfers control from user mode to kernel mode. 
	* The kernel performs the requested operation after validating the parameters and checking access rights of the calling process.
* If the thread is authroised, The thread is transitioned from user mode to kernel mode. 
* The kernel maintains a table known as the *System Service Descriptor Table (SSDT)* or the *Syscall table*. This is a data structure that contains pointers to the various system services routines. 
	* These routines handle system calls made by user-mode applications. Each entry in the table corresponds to a specific system call number and its assoicated pointer. 
* The syscall responsible for *ReadProcessMemory* is executed in the kernel, where the Windows memory management and process isolation mechanisms are leveraged. 

## Portable Executable

* Windows employs *Portable Executables (PE)* format to encapsulate executable programs, *DLLs* and other integral system components. 
* They can incorporate a wide variety of data types including *executables (.exe)*, *DLLs*, *kernel modules (.srv)*, *control pannel applications (.cpl)*.
### PE Sections 
* PE house a *section table*. This is an element compromising several sections dedicated to distinct purposes. 
* Common sections: 

| Section                               | Use|     
| ------------------------------------- | ------------------------------------------------------------------------------------------------------------ | 
| `Text Section (.text)`                | The hub where the executable code of the program resides.                                                    |     |
| `Data Section (.data)`:               | A storage for initialised global and static data variables                                                   |     |
| `Read-only initialized data (.rdata)` | Houses read-only data such as constant values, string literals, and initialised global and static variables. |     |
| `Exception information (.pdata)`      | A collection of function table entries utilized for exception handling.                                      |     |
| `BSS Section (.bss)`                  | Holds uninitialized global and static data variables.                                                        |     |
| `Resource Section (.rsrc)`            | Safeguards resources such as images, icons, strings, and version information.                                |     |
| `Import Section (.idata)`             | Details about functions imported from other DLLs.                                                            |     |
| `Export Section (.edata)`             | Information about functions exported by the executable.                                                      |     |
| `Relocation Section (.reloc)`         | Details for relocating the executable's code and data when loaded at a different memory address.             |    

### Processes
* An instance of an executing program. Represents a slice of a programs execution in memory and consists of various resources including memory, file handles, threads and security contexts.
![[Pasted image 20231031104135.png]]
Each Processes is characterised by:

| Name                                   | Use                                                                                                                                                                                                                                                                                    |
| -------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `A unique PID (Process Identifier)`    | A unique Process Identifier (PID) is assigned to each process within the operating system. This numeric identifier facilitates the tracking and management of the process by the operating system.iq                                                                                   |
| `Virtual Address Space (VAS)`          | In the Windows OS, every process is allocated its own virtual address space, offering a virtualized view of the memory for the process. The VAS is sectioned into segments, including code, data, and stack segments, allowing the process isolated memory access.                     |
| `Executable Code (Image File on Disk)` | The executable code, or the image file, signifies the binary executable file stored on the disk. It houses the instructions and resources necessary for the process to operate.                                                                                                        |
| `Table of Handles to System Objects`   | Processes maintain a table of handles, a reference catalogue for various system objects. System objects can span files, devices, registry keys, synchronization objects, and other resources.                                                                                          |
| `Security Context (Access Token)`      | Each process has a security context associated with it, embodied by an `Access Token`. This `Access Token` encapsulates information about the process's security privileges, including the user account under which the process operates and the access rights granted to the process. |
|   `One or More Threads Running in its Context` |Processes consist of one or more threads, where a thread embodies a unit of execution within the process. Threads enable concurrent execution within the process and facilitate multitasking.|

## Dynamic-Link Library 
* A type of PE which represents "Microsoft's implementation of the shared library concept in Windows". DLLs expose lots of functions which can be exploited by malware. 
### Import Functions 
* Functions that a binary dynamically linked to from an external library or module during run time. These functions enable the binary to leverage the functionality offered by these libraries. 
* Examining import functions may shed light on the external libraries or modules that the malware is dependent on. This information aids in identifying the APIs that the malware might interact with and resources such as file system, processes, registry. 
* Import function names or hashes can server as Indicators of compromise. 
#### Example
![[Pasted image 20231031105017.png]]
- `OpenProcess`: Opens a handle to the target process (notepad.exe), providing the necessary access rights to manipulate its memory.
- `VirtualAllocEx`: Allocates a block of memory within the address space of the target process to store the injected code.
- `WriteProcessMemory`: Writes the desired code into the allocated memory block of the target process.
- `CreateRemoteThread`: Creates a new thread within the target process, specifying the entry point of the injected code as the starting point.
### Export Functions
* Functions that a binary exposes for use by other modules or applications. 
* These functions provide an interface or other software to interact with the binary. #
#### Example:
![[Pasted image 20231031105602.png]]
* *Imports*: This shows the DLLs and their functions imported by an executable *utilman.exe
* *Exports*: This shows the functions exported by a DLL *kernel.dll*